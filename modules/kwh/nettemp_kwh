#! /bin/bash

dir=$(cd "$( dirname "$0" )" && cat ../../conf.php |grep global | awk -F"\'" '{ print $2 }')

if [[ "`pidof -x $(basename $0) -o %PPID`" ]]; then echo "Already running" && exit; fi

mkdir -p $dir/tmp/kwh 1> /dev/null
gpio=$(sqlite3 $dir/dbf/nettemp.db  "SELECT gpio FROM gpio WHERE gpio_kwh='on'")
divider=$(sqlite3 $dir/dbf/nettemp.db  "SELECT gpio_kwh_divider FROM gpio WHERE $gpio")
hilo=$(sqlite3 $dir/dbf/nettemp.db  "SELECT gpio_kwh_hilo FROM gpio WHERE $gpio")


if [ -n "$gpio" ]; then

while :
do
    #sleep 0.1
    SLEEP=$(($RANDOM % 10))
    sleep $SLEEP
    
    if [ ! -e $dir/tmp/kwh/kwh_count_$(date +%y%m%d) ]; then
	i=0
    fi
    
    i=$(cat $dir/tmp/kwh/kwh_count_$(date +%y%m%d) 2> /dev/null )
    status=$(gpio -g read $gpio)
    if [ "$status" == "$hilo" ]; then
        i=$((i+1))
	echo $i imp
	echo $i > $dir/tmp/kwh/kwh_count_$(date +%y%m%d)
	time1=$(cat $dir/tmp/kwh/timestamp)
	echo $(date +%s) > $dir/tmp/kwh/timestamp
	time2=$(date +%s)
	diff=$[$time2 - $time1]
	if [ "$diff" == "0" ]; then 
	diff="1"
	fi
	wh=$(echo "scale=3; ((1000/$divider*(3.6*1000))/$divider)/$diff" |bc -l | tr -d '.')
	echo $wh Wh
	echo $wh > $dir/tmp/kwh/wh
	unset time1
	unset time2
    fi
done
else 
    echo "no gpio"
fi






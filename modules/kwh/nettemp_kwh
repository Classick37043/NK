#!/bin/bash

dir=$(cd "$( dirname "$0" )" && cat ../../conf.php |grep global | awk -F"\'" '{ print $2 }')
mkdir -p $dir/tmp/kwh 1> /dev/null
gpio=$(sqlite3 $dir/dbf/nettemp.db  "SELECT gpio FROM gpio WHERE gpio_kwh='on'")
hilo="1"

if [ -n "$gpio" ]; then

while :
do
    sleep 0.1

    if [ ! -e $dir/tmp/kwh/kwh_count_$(date +%y%m%d) ]; then
	i=0
    fi
    
    i=$(cat $dir/tmp/kwh/kwh_count_$(date +%y%m%d) 2> /dev/null )
    status=$(gpio -g read $gpio)
    if [ "$status" == "$hilo" ]; then
        i=$((i+1))
	echo $i
	echo $i > $dir/tmp/kwh/kwh_count_$(date +%y%m%d)
	time1=$(cat $dir/tmp/kwh/timestamp)
	time2=$(date +%s)
	echo $time2 > $dir/tmp/kwh/timestamp
	diff=$[$time2 - $time1]
	if [ "$diff" == "0" ]; then 
	diff="1"
	fi
	wh=$[3600/$diff]
	echo $wh Wh
	echo $wh > $dir/tmp/kwh/wh
	echo $(date +%s) > $dir/tmp/kwh/timestamp
    fi
done
else 
    echo "no gpio"
fi






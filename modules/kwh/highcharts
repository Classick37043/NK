#! /bin/bash -x

dir=$( cd "$( dirname "$0" )" && cd ../../ && pwd )

mkdir -p $dir/tmp/kwh 1> /dev/null
gpio=$(sqlite3 $dir/dbf/nettemp.db  "SELECT gpio FROM gpio WHERE mode='kwh'")

if [ -n "$gpio" ]; then
divider=$(sqlite3 $dir/dbf/nettemp.db  "SELECT kwh_divider FROM gpio WHERE gpio='$gpio'")
if [ -z "$divider" ]; then 
divider="1"
fi

i=$(cat $dir/tmp/kwh/kwh_count_$(date +%y%m%d%H) 2> /dev/null )
echo "$[($(date +%s)+7200)*1000],$[$i]" > $dir/tmp/kwh/kwh_daily_$(date +%y%m%d%H)
#cat $dir/tmp/kwh/kwh_daily* > $dir/db/gpio_kwh.db
#echo $(echo '[' ; cat $dir/db/gpio_kwh.db | awk -F "," '{print $1","$2 / '$divider' }' |sed -e 's/^/[/'|sed -e 's/,$/,/'|sed -e 's/\([^,]\)$/\1\],/'; sed 's/.$//' ; echo  ']') > $dir/db/gpio_kwh_highcharts.json
middle=$(cat $dir/tmp/kwh/kwh_daily* | awk -F "," '{print "["$1","$2 / '$divider'"]," }')
echo -e "[ ${middle%?} ]" > $dir/db/gpio_kwh.json

else 
    echo "kWh OFF"
fi

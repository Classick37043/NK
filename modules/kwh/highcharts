#! /bin/bash -x

dir=$( cd "$( dirname "$0" )" && cd ../../ && pwd )

mkdir -p $dir/tmp/kwh 1> /dev/null
gpio=$(sqlite3 $dir/dbf/nettemp.db  "SELECT gpio FROM gpio WHERE mode='kwh'")

if [ -n "$gpio" ]; then
divider=$(sqlite3 $dir/dbf/nettemp.db  "SELECT kwh_divider FROM gpio WHERE gpio='$gpio'")
if [ -z "$divider" ]; then 
divider="1"
fi

hour=$(cat $dir/tmp/kwh/kwh_count_$(date +%y%m%d%H) 2> /dev/null )
echo "$[($(date +%s)+3600)*1000],$[$hour]" > $dir/tmp/kwh/kwh_hour_$(date +%y%m%d%H)
middle=$(cat $dir/tmp/kwh/kwh_hour* | awk -F "," '{print "["$1","$2 / '$divider'"]," }')
echo -e "[ ${middle%?} ]" > $dir/db/gpio_kwh_hour.json

day=$(cat $dir/tmp/kwh/kwh_hour_$(date +%y%m%d)* 2> /dev/null )
echo "$day" > $dir/tmp/kwh/kwh_day_$(date +%y%m%d)
middle=$(cat $dir/tmp/kwh/kwh_day* | awk -F "," '{print "["$1","$2 / '$divider'"]," }')
echo -e "[ ${middle%?} ]" > $dir/db/gpio_kwh_day.json




else 
    echo "kWh OFF"
fi

#! /bin/bash -x

dir=$( cd "$( dirname "$0" )" && cd ../../ && pwd )
date=`date +%y%m%d-%H%M`

rm -rf $dir/tmp/.digitemprc
rm -rf $dir/tmp/onewire
mkdir $dir/tmp

echo "$date temp_dev_scan - Deleted .digitemprc" >> $dir/tmp/log.txt

# DS9097U na USB - meraprojekt new
for i in 0 1 2 3
    do
	if [ `ls /dev/ttyUSB$i 2> /dev/null` ]; then 
	/usr/bin/digitemp_DS9097U -i -c $dir/tmp/.digitemprc -s/dev/ttyUSB$i
	fi
    done
	if [ -e $dir/tmp/.digitemprc ]; then 
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET usb='DS9097U'"
	echo "$date temp_dev_scan - Discovered DS9097U on USB" >> $dir/tmp/log.txt
	else
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET usb='off' WHERE id='1'"
	fi


# DS2490 na USB - meraprojekt old
if [ ! -e $dir/tmp/.digitemprc ]; then 
    /usr/bin/digitemp_DS2490 -i -c $dir/tmp/.digitemprc 
    if [ -e $dir/tmp/.digitemprc ]; then 
    sqlite3 $dir/dbf/nettemp.db "UPDATE device SET usb='DS2490'"
    echo "$date temp_dev_scan - Discovered DS2490 on USB" >> $dir/tmp/log.txt
    else
    sqlite3 $dir/dbf/nettemp.db "UPDATE device SET usb='off' WHERE id='1'"
    fi
fi

# DS9097 na USB - serial na przejsciowce USB
if [ ! -e $dir/tmp/.digitemprc ]; then 
    for i in 0 1 2 3
	do
	    if [ `ls /dev/ttyUSB$i 2> /dev/null` ]; then 
	    /usr/bin/digitemp_DS9097 -i -c $dir/tmp/.digitemprc -s/dev/ttyUSB$i
	    fi
	done
    if [ -e $dir/tmp/.digitemprc ]; then 
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET usb='DS9097' WHERE id='1'"
	echo "$date temp_dev_scan - Discovered DS9097 on USB" >> $dir/tmp/log.txt
	else
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET usb='off'"
    fi
fi

# DS9097 - serial 
if [ ! -e $dir/tmp/.digitemprc ]; then 
    for i in 0 1 2 3
	do
	    if [ `ls /dev/ttyS$i 2> /dev/null` ]; then 
	    /usr/bin/digitemp_DS9097 -i -c $dir/tmp/.digitemprc -s/dev/ttyS$i
	    fi
	done
    if [ -e $dir/tmp/.digitemprc ]; then 
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET serial='DS9097' WHERE id='1'"
	echo "$date temp_dev_scan - Discovered DS9097 on serial port" >> $dir/tmp/log.txt
	else
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET serial='off'"
    fi
fi

# 1-wire

if [ -e /sys/bus/w1/devices/w1_bus_master1/w1_master_slaves ]; then 
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET onewire='on' WHERE id='1'"
	echo "$date temp_dev_scan - Discovered 1-wire temp sensors" >> $dir/tmp/log.txt

# scan 1-wire
	#modprobe wire
	#modprobe w1_gpio
	#modprobe w1_therm

	
for sensor in `cat /sys/bus/w1/devices/w1_bus_master1/w1_master_slaves`; do 

	
    if  [ -e /sys/bus/w1/devices/${sensor}/w1_slave ]; then
      wynik=`awk -F'[ =]' ' $11 ~ /crc/ && $13 ~ /YES/ { getline; printf "%3.2f\n", $11/1000 } ' /sys/bus/w1/devices/${sensor}/w1_slave;`

    	echo $sensor  >>  $dir/tmp/onewire
    fi

done


else
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET onewire='off' WHERE id='1'"
fi


#RPI system temp

if [ ! $(cat $dir/tmp/onewire |grep Raspberry_Pi) ] && [ -e /opt/vc/bin/vcgencmd ]; then
    echo "Raspberry_Pi" >> $dir/tmp/onewire
    echo "add pi to onewire"
fi

# DHT11 22
dht=`sqlite3 $dir/dbf/nettemp.db "SELECT gpio FROM gpio where humi_checkbox='on'"`

for dht_gpio in $dht; do
 tmp1="gpio_$dht_gpio" 
 tmp2="_temp"
 echo "$tmp1$tmp2" >> $dir/tmp/onewire
 dht1="gpio_$dht_gpio"
 dht2="_humi"
 echo "$dht1$dht2" >> $dir/tmp/onewire
done

# snmp
snmp=`sqlite3 $dir/dbf/snmp.db "SELECT name FROM snmp"`
for name in $snmp; do 
 echo "$name" >> $dir/tmp/onewire
done

# i2c

bmp180="77" #0x77
TSL2561="39" #0x39

add(){
dir=$( cd "$( dirname "$0" )" && cd ../../ && pwd )
for i in $i2c; do
	    if [ "$i" = "$bmp180" ]; then
		echo i2c_$i\_pressure >> $dir/tmp/onewire
		echo i2c_$i\_temp >> $dir/tmp/onewire
		echo i2c_$i\_altitude >> $dir/tmp/onewire
	    fi
	    if [ "$i" = "$TSL2561" ]; then
		echo i2c_$i\_lux >> $dir/tmp/onewire
	    fi
	done
}


if [ -e /dev/i2c-0 ] || [ -e /dev/i2c-1 ]; then
	echo "searching I2C" 
	sqlite3 $dir/dbf/nettemp.db "UPDATE device SET i2c='on' WHERE id='1'"
	i2c=$(sudo i2cdetect -y 0 |sed '1d'|awk '{ $1=""; print $0 }' |grep -o '[0-9]*')
    	if [ -n "$i2c" ];then
	    add
	else 
	i2c=$(sudo i2cdetect -y 1 |sed '1d'|awk '{ $1=""; print $0 }' |grep -o '[0-9]*')
	    add	
    	fi
	echo "$date temp_dev_scan - Discovered I2C interface" >> $dir/tmp/log.txt
else
    echo "No I2C"
    sqlite3 $dir/dbf/nettemp.db "UPDATE device SET i2c='off' WHERE id='1'"
fi











